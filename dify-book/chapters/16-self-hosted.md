# 第 16 章：私有部署——数据完全自主可控

> TechStore 的 AI 工具越来越深入业务了。有一天，CTO 把小林和 IT 部门叫到一起开会。
>
> *"我们现在用的 Dify 云服务，数据都存在他们的服务器上对吧？"*
>
> *"是的，存在 Dify 的云端服务器上。"* IT 总监回答。
>
> *"这个有点问题。我们的客服对话里可能有客户手机号、订单号这些信息。如果将来业务数据也接进来，风险更大。能不能把 Dify 部署到我们自己的服务器上？"*
>
> IT 总监看向小林：*"Dify 支持私有部署吗？"*
>
> *"支持的，Dify 提供私有部署方案。"*

## 云服务 vs 私有部署

| | 云服务 | 私有部署 |
|---|--------|----------|
| 部署位置 | Dify 的服务器 | 你自己的服务器 |
| 运维责任 | Dify 负责 | 你自己负责 |
| 数据存储 | 在 Dify 云端服务器 | 完全自己控制 |
| 费用 | 按用量付费 | 只需服务器成本 |
| 上手难度 | 开箱即用 | 需要技术能力 |

**什么时候选私有部署？**
- 处理敏感数据（客户信息、商业机密）
- 有数据本地化合规要求
- 需要深度定制
- 有专业运维团队

TechStore 的情况：客服对话涉及客户信息，未来可能接入业务数据。私有部署是更稳妥的选择。

## Docker Compose 部署

IT 部的运维同事老张说：*"用 Docker Compose 部署最简单，我来操作。"*

**前提条件：**
- 一台服务器（最低 2 核 CPU、4GB 内存；生产环境建议 4 核、8GB 以上）
- 安装了 Docker 和 Docker Compose

**部署步骤：**

```bash
# 1. 下载 Dify 最新 release 版本（推荐，比直接 clone 主分支更稳定）
git clone --branch "$(curl -s https://api.github.com/repos/langgenius/dify/releases/latest | jq -r .tag_name)" https://github.com/langgenius/dify.git
cd dify/docker

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env，修改默认密码！

# 3. 启动服务
docker compose up -d
```

这个命令会启动一堆容器：nginx、web、api、worker、db（PostgreSQL，也承担向量存储）、redis……

**第 4 步：访问**

打开浏览器，访问 `http://服务器IP`

首次访问会要求设置管理员账号。

---

老张操作完，前后不到 10 分钟。

*"这就好了？"* 小林有点意外。

*"容器化部署就是这么简单。但这只是开发测试环境，生产环境还要做些加固。"*

## 生产环境加固

老张继续说：*"要上生产，还有几件事要做。"*

1. **配置 HTTPS**：用 Nginx 配置 SSL 证书
2. **修改默认密码**：.env 文件里的密码都要改
3. **配置备份**：数据库定期备份
4. **监控告警**：监控服务器和容器状态
5. **访问控制**：防火墙、IP 白名单

老张花了大半天时间，把这些都配置好了。

*"现在可以迁移你的应用过来了。"*

小林登录新部署的 Dify，把之前导出的 DSL 文件导入，应用就恢复了。

*"知识库的文档需要重新传，对话历史不迁移也没关系。"*

小林花了一个下午，把所有应用和知识库都迁移到了私有部署的 Dify 上。

**从此，TechStore 的 AI 应用数据，完全存在自己的服务器上了。**

## 成本对比

财务部问小林：*"私有部署省钱吗？"*

| | 云服务（Team plan）| 私有部署 |
|---|------------------|----------|
| 月费 | ~$159/月 | — |
| 服务器 | — | ~$50–100/月（cloud VM）|
| LLM 调用费 | 另算 | 另算 |
| 运维人力 | 无 | IT 部兼顾 |

**结论：**
- 用量大 → 私有部署更省钱
- 用量小 → 云服务更省心
- 有数据合规要求 → 私有部署是必须的

## 后续运维

部署上线只是开始。

**日常维护：**
- 监控服务器状态
- 定期检查备份
- 查看使用日志

**版本升级：**
```bash
cd dify/docker
git pull
docker compose down
docker compose up -d
```

::: tip 建议
不要追最新版，等稳定一两周再升。
:::

小林和老张约定：每周碰一次，review 系统状态。

*"有问题随时叫我。"* 老张说。

*"好的，张哥你真是太靠谱了。"*

这件事让小林明白了一个道理：技术活还是得找专业的人。自己该干的是搞清楚需求、拉对人、把事情推动起来。
