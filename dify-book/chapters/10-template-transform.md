# 第 10 章：格式优化——模板转换节点

> 周报 Workflow 很好用，但小林发现一个问题：
>
> 每次生成的周报格式不太一致。有时候用 Markdown，有时候混合了其他格式。有时候数据用表格，有时候用列表。
>
> "我希望输出格式永远是一样的，不要每次都不同。"
>
> 这就需要用到「模板转换」节点。

## 什么是模板转换

模板转换节点让你可以用**固定的模板**来格式化数据。

它使用 **Jinja2** 模板语法——一种简单但强大的模板语言。

**基本概念：**
- **变量**：用 `{{ 变量名 }}` 表示，会被实际值替换
- **循环**：用 `{% for item in list %}` 遍历列表
- **条件**：用 `{% if 条件 %}` 进行判断

**示例：**

模板：
```
尊敬的 {{ customer_name }}：
您的订单 {{ order_id }} 已发货。
```

输入：
```
customer_name = "张三"
order_id = "2024001"
```

输出：
```
尊敬的 张三：
您的订单 2024001 已发货。
```

用模板转换，你可以确保输出格式永远一致。

## 在周报中应用模板

修改周报 Workflow：

1. 在「周报生成」LLM 节点后，添加「模板转换」节点
2. 配置模板转换：

**输入变量：**
- `report_content`：周报生成节点的输出
- `week_range`：开始节点的日期范围

**模板内容：**

```
=====================================
        TECHSTORE 运营周报
=====================================

报告周期：{{ week_range }}
生成时间：{{ current_time }}

-------------------------------------

{{ report_content }}

-------------------------------------

【附注】
本报告由 AI 自动生成，数据来源于各业务系统。
如有疑问，请联系运营部门。

=====================================
```

3. 把模板转换的输出连接到结束节点

现在，无论 LLM 生成什么内容，最终输出都会被包装在这个固定格式中。

## 处理列表数据

模板转换在处理列表数据时特别有用。

比如，在客服场景中，迭代节点会输出一个答案列表。我们可以用模板转换来格式化：

```jinja2
尊敬的客户：

感谢您的咨询，以下是您问题的解答：

{% for i in range(answers|length) %}
【问题 {{ i + 1 }}】
{{ questions[i] }}

【解答】
{{ answers[i] }}

{% endfor %}

如有其他问题，欢迎随时咨询。

TechStore 客服团队
```

**输入：**
```
questions = ["有白色吗？", "现在有优惠吗？", "可以退货吗？"]
answers = ["有的，...", "目前有...", "可以，..."]
```

**输出：**
```
尊敬的客户：

感谢您的咨询，以下是您问题的解答：

【问题 1】
有白色吗？

【解答】
有的，TechPhone Pro 16 有冰川白配色……

【问题 2】
现在有优惠吗？

【解答】
目前有以旧换新活动……

【问题 3】
可以退货吗？

【解答】
可以，7 天内未拆封可退……

如有其他问题，欢迎随时咨询。

TechStore 客服团队
```

## 常用 Jinja2 语法速查

**变量输出：**
```jinja2
{{ variable }}
```

**条件判断：**
```jinja2
{% if score > 90 %}
优秀
{% elif score > 60 %}
及格
{% else %}
不及格
{% endif %}
```

**循环遍历：**
```jinja2
{% for item in list %}
- {{ item }}
{% endfor %}
```

**带索引的循环：**
```jinja2
{% for item in list %}
{{ loop.index }}. {{ item }}
{% endfor %}
```

**过滤器（处理变量）：**
```jinja2
{{ text | upper }}        → 转大写
{{ text | lower }}        → 转小写
{{ text | length }}       → 获取长度
{{ list | join(", ") }}   → 用逗号连接列表
```

**默认值：**
```jinja2
{{ name | default("匿名用户") }}
```

::: tip 小提示
不确定语法时，可以问 AI："怎么用 Jinja2 实现 XXX"。
:::

---

小林把周报的输出格式固定下来后，老板再也没说过"格式不统一"了。

*"小事情，但很影响专业度。"*
