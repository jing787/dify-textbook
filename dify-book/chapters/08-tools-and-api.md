# 第 8 章：连接外部世界——查快递、搜网络

> TechStore 客服已经很强大了。但还有一类问题它处理不了：
>
> 客户问：*「我的订单 2025112800001 到哪了？」*
>
> AI 回答：*「请您查看物流信息……」*
>
> 这个回答没有错，但没有用。客户想知道的是**具体的物流状态**，而这个信息不在知识库里——它需要实时查询快递公司的系统。
>
> "我需要让 AI 能调用外部工具。"
>
> 这就是 Agent 节点和工具调用的用途。

## 理解工具调用

虽然现在很多 AI 产品已经内置了联网搜索和工具调用，但在 Dify 的 Workflow 里，一个普通的 LLM 节点默认只能处理文本——它不会自己去查快递、搜网页。

你需要显式地给它"装"上工具：

1. **信息获取**——搜索引擎、数据库查询、API 调用，让 AI 拿到实时数据
2. **执行操作**——发邮件、写数据库、调用内部系统，让 AI 真的"动手"

**工具调用（Tool Calling）** 就是干这个的。

你可以给 AI 配备各种"工具"：
- 搜索引擎：查询最新信息
- 快递查询 API：获取物流状态
- 数据库查询：获取业务数据
- 计算器：进行精确计算
- 发送邮件：执行实际操作

AI 会根据用户的问题，**判断需要使用什么工具**，调用工具获取结果，然后基于结果给出回答。

这就像给助理配备了电脑和电话——助理不再只能靠记忆回答，而是可以"查一下"。

## Dify 的插件市场

Dify 的工具能力通过**插件市场（Marketplace）** 提供。你可以把插件市场理解为手机的应用商店——需要什么能力，去市场里装一个就行。

插件市场里的内容分成几大类：

**Tools（工具类插件）** 是最常用的。搜索引擎、天气查询、数学计算、代码执行……这些都是以插件形式存在的，用之前需要先安装。Google Search、DuckDuckGo、Wikipedia、Slack、Notion、GitHub——社区在持续贡献新的工具插件。

**Models（模型插件）** 用来接入各种大语言模型。OpenAI、Anthropic、Google Gemini、AWS Bedrock……每个模型供应商也是一个插件。

**Agent Strategies（推理策略）** 和 **Extensions（扩展）** 是更进阶的类别，后面碰到时再说。

除了市场里现成的插件，你还可以通过 **HTTP 请求节点**调用任意 API，或者用**代码节点**实现自定义逻辑。所以就算插件市场里没有你要的工具，也总有办法接入。

## 第一步：从插件市场安装搜索工具

1. 点击 Dify 顶部导航的「插件」（Plugins）
2. 进入插件市场，搜索「DuckDuckGo」
3. 点击「安装」——DuckDuckGo 不需要 API Key，适合新手练手

安装完成后，这个工具就可以在 Workflow 中使用了。你随时可以回到插件市场安装更多工具。

## 第二步：添加 Agent 节点

Agent 节点是一个独立的节点类型（不是 LLM 节点的变体）。它的特点是能**自主决定是否调用工具**，并且支持多轮工具调用——调用工具 → 分析结果 → 决定要不要继续调。

1. 在 Workflow 中添加「Agent」节点
2. 配置：

**选择模型**：gpt-5（推荐，工具调用更准确）或 gpt-4o-mini

**配置工具**：勾选你要使用的工具，比如「DuckDuckGo 搜索」

**System 提示词**：
```
你是 TechStore 的智能客服。当客户询问产品对比、市场评价等需要最新信息的问题时，请使用搜索工具获取信息。

工具使用原则：
1. 只在确实需要外部信息时使用工具
2. 搜索前先明确搜索关键词
3. 搜索结果要结合 TechStore 的产品进行分析

回答要求：
1. 客观公正，不过度推销
2. 如果搜索结果不确定，要说明
3. 引用信息时注明来源
```

## 第三步：测试搜索功能

**输入：**
```
TechPhone Pro 16 和 iPhone 16 相比怎么样？
```

观察 Agent 的执行过程：

1. Agent 分析问题，判断需要搜索外部信息
2. Agent 调用 DuckDuckGo 搜索"TechPhone Pro 16 vs iPhone 16"
3. 搜索返回相关文章和评测
4. Agent 基于搜索结果生成回答

**输出示例：**
```
根据网络上的评测和对比，TechPhone Pro 16 和 iPhone 16 各有优势：

屏幕：TechPhone Pro 16 采用 6.7 英寸 AMOLED 屏幕，支持 120Hz 刷新率；
iPhone 16 是 6.1 英寸 Super Retina XDR 屏幕，刷新率 60Hz（Pro 系列支持 120Hz）。

性能：TechPhone Pro 16 搭载 Snapdragon 8 Gen 3，iPhone 16 搭载 A18 芯片。
从跑分来看……

价格：TechPhone Pro 16 起售价 $599，iPhone 16 起售价 $799。
在性价比上 TechStore 的产品有明显优势。

如果您更看重性价比和快充，推荐 TechPhone Pro 16；
如果您偏好 iOS 生态，iPhone 16 也是不错的选择。
```

## 第四步：添加 HTTP 请求（模拟快递查询）

对于快递查询这类内部系统，需要用 HTTP 请求节点调用 API。

1. 添加「HTTP 请求」节点
2. 配置：
   - 方法：GET
   - URL：`https://api.example.com/logistics/{{order_id}}`
   - Headers：根据 API 要求配置
3. 添加 LLM 节点解读结果：

```
请将以下物流信息转化为客户友好的回复：

物流数据：
{{http_response}}

回答要求：
1. 用自然语言描述物流状态
2. 告知预计送达时间（如果有）
3. 如果物流异常，给出建议
```

::: warning 注意
这是一个简化示例。实际项目中，你需要：
- 有真实的快递查询 API（FedEx Tracking API、UPS API 等）
- 配置正确的认证信息
- 处理各种异常情况
:::

## 整合到完整流程

现在，让我们把搜索和 API 调用整合到 TechStore 客服的完整流程中：

**更新条件分支逻辑：**

| 问题类型 | 处理方式 |
|----------|----------|
| 产品咨询（不需外部信息）| 知识库 + LLM |
| 产品对比（需要外部信息）| Agent + 搜索工具 |
| 物流查询 | HTTP 请求 + LLM |
| 售后服务 | 知识库 + LLM |
| 投诉/其他 | 安抚话术 + 转人工 |

完整的 Workflow 现在可以：
- ✅ 回答产品基本问题（知识库）
- ✅ 对比竞品信息（网络搜索）
- ✅ 查询订单物流（API 调用）
- ✅ 处理售后咨询（知识库）
- ✅ 安抚投诉客户（话术模板）

---

小林看了一眼完整的 Workflow，心想：这东西已经比不少真人客服靠谱了。

从一个只会背 FAQ 的 Chatbot，到现在能分类、能拆解、能查物流——但还差一块：多轮对话的记忆。客户说了预算，下一句 AI 就忘了，体验还是不行。下一章补上这块。
