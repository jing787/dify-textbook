# 第 9 章：升级为 Chatflow——让客服拥有记忆

> TechStore 的 AI 客服已经能分类、能拆解、能查询了。但客服组长反馈了一个新问题：
>
> *"客户跟 AI 对话，上一句刚说完预算 5000，下一句 AI 就忘了，又问一遍。客户觉得我们的 AI 很傻。"*
>
> 小林试了一下，确实：
>
> ```
> 客户：我想买一台手机
> AI：好的，请问您的预算是多少？
> 客户：5000 左右
> AI：请问您想了解哪款产品？（完全没记住预算）
> ```
>
> 问题出在哪？**Workflow 每次执行都是独立的，没有"记忆"。**
>
> "我需要一种能记住对话上下文的方式。"
>
> 这就是 Chatflow 的用途。

## Chatflow 和 Workflow 的区别

在第 4 章我们提到过 Dify 的五种应用类型。现在来详细对比 Workflow 和 Chatflow：

| | Workflow | Chatflow |
|---|---------|----------|
| **交互方式** | 单次输入 → 单次输出 | 多轮对话 |
| **记忆能力** | 无，每次执行互相独立 | 有，能记住对话上下文 |
| **内置变量** | 无 | `sys.query`（当前用户输入）、`sys.conversation_id` 等 |
| **会话变量** | 不支持 | 支持，跨轮次持久化 |
| **适用场景** | 一次性任务（报告生成、内容批量生产） | 需要多轮交互的场景（客服、咨询、引导式问答） |

**简单说：Workflow 是"一锤子买卖"，Chatflow 是"持续对话"。**

客服场景天然需要多轮对话——客户不会一次把所有信息都说清楚，AI 需要追问、确认、记住之前的信息。

## 第一步：创建 Chatflow 应用

1. 工作室 → 创建空白应用
2. 选择应用类型：**Chatflow**
3. 命名为"TechStore 智能客服 v3"
4. 点击创建

你会看到和 Workflow 类似的画布界面，但有几个不同：

- **开始节点**自带 `sys.query` 变量（用户当前输入），不需要手动定义输入变量
- 多了**「对话记忆」**相关的设置
- 结束节点变成了**「直接回复」**节点

## 第二步：搭建基础对话流程

先把之前 Workflow 的核心流程搬过来：

**1. 添加问题分类器节点**

连接到「开始」节点后面。

配置分类：
- 类别 1：产品咨询——询问产品信息、价格、功能、推荐
- 类别 2：售后服务——退换货、保修、物流、退款
- 类别 3：投诉建议——表达不满、提出批评
- 类别 4：其他

**2. 为每个分类添加处理流程**

和之前的 Workflow 一样：
- 产品咨询 → 产品知识库 → LLM 回答
- 售后服务 → FAQ 知识库 → LLM 回答
- 投诉/其他 → 安抚话术 LLM

**3. 连接到「直接回复」节点**

Chatflow 用「直接回复」代替 Workflow 的「结束」节点。它会把 LLM 的输出直接发送给用户，并保留在对话历史中。

::: tip 直接回复 vs 结束
- Workflow 的「结束」：输出结果后流程结束，下次执行是全新的
- Chatflow 的「直接回复」：输出结果后等待用户下一轮输入，对话上下文保留
:::

到这一步，你已经有了一个能多轮对话的客服。但还差一个关键能力——**记住用户告诉过你的信息**。

## 第三步：使用会话变量

**会话变量（Conversation Variable）** 是 Chatflow 独有的能力。它允许你在多轮对话中存储和读取信息。

### 创建会话变量

1. 点击画布顶部的「会话变量」按钮
2. 添加变量：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `user_budget` | String | 用户预算 |
| `user_preference` | String | 用户偏好（品牌、功能等） |
| `order_id` | String | 订单号（退换货场景用） |

这些变量会在整个对话过程中持续存在，不会因为新一轮对话而消失。

### 用参数提取器提取信息

在问题分类器之前，添加一个「参数提取器」节点：

**输入变量**：`sys.query`

**提取参数**：
- `budget`：String，用户提到的预算范围
- `preference`：String，用户提到的品牌或功能偏好
- `order_id`：String，用户提到的订单号

**提取指令**：
```
从用户消息中提取以下信息（如果有的话）。
如果用户没有提到某个信息，该字段返回空字符串。
- budget：预算金额或范围
- preference：品牌偏好、功能需求、使用场景
- order_id：订单编号
```

### 用变量赋值器存储信息

「变量赋值器（Variable Assigner）」节点可以把提取到的信息写入会话变量。

1. 在参数提取器后面添加「变量赋值器」节点
2. 配置：
   - 将 `budget` 写入会话变量 `user_budget`（仅当值不为空时）
   - 将 `preference` 写入会话变量 `user_preference`（仅当值不为空时）
   - 将 `order_id` 写入会话变量 `order_id`（仅当值不为空时）

### 在 LLM 中使用会话变量

现在，产品咨询分支的 LLM 提示词可以这样写：

```
你是 TechStore 的产品顾问。请根据产品资料和客户信息，回答问题。

已知客户信息：
- 预算：{{user_budget}}
- 偏好：{{user_preference}}

参考资料：
{{#context#}}

回答要求：
1. 如果已知客户预算，推荐符合预算的产品
2. 如果已知客户偏好，优先推荐匹配的产品
3. 如果信息不足，自然地追问
4. 语气友好，像真人顾问一样交流
```

## 第四步：测试多轮对话

点击「预览」，开始测试：

```
客户：我想买一台手机
AI：好的！请问您的预算大概是多少？有没有特别看重的功能，比如拍照、续航、游戏？

客户：预算 5000 左右，主要拍照好的
AI：5000 元价位拍照出色的话，推荐我们的 TechPhone Pro 16（5999 元起）。
    它搭载 5000 万主摄 + 6400 万长焦，支持徕卡影像……
    如果预算想控制更紧一些，TechPad Air 11 的拍照也不错。
    您想了解哪款的详细配置？

客户：Pro 16 有白色吗？
AI：有的！TechPhone Pro 16 有三种配色：星空黑、冰川白和暮光紫。
    冰川白非常受欢迎，要看看实拍图吗？
```

注意：第三轮对话中，AI 没有再问"您想买什么"，因为它**记住了**用户在聊 TechPhone Pro 16。

## 完整的 Chatflow 结构

```
开始（接收 sys.query）
    ↓
参数提取器（提取预算/偏好/订单号）
    ↓
变量赋值器（写入会话变量）
    ↓
问题分类器
    ├── 产品咨询 → 产品知识库 → 产品顾问 LLM（引用会话变量）
    ├── 售后服务 → FAQ 知识库 → 售后专员 LLM（引用 order_id）
    ├── 投诉建议 → 安抚话术 LLM
    └── 其他 → 通用回答 LLM
    ↓
直接回复
```

## Chatbot → Workflow → Chatflow 的升级路径

让我们回顾一下 TechStore 客服的完整升级过程：

| 版本 | 应用类型 | 能力 |
|------|----------|------|
| v1 | Chatbot | 简单问答，查知识库 |
| v2 | Workflow | 分类处理、迭代拆解、工具调用 |
| v3 | Chatflow | 在 v2 基础上 + 多轮对话记忆 |

这也是 Dify 上典型的应用升级路径：

1. **先用 Chatbot 验证想法**——最快出活，几分钟搞定
2. **用 Workflow 增强逻辑**——加入分支、迭代、工具等高级能力
3. **用 Chatflow 提升体验**——加入对话记忆，让交互更自然

---

小林把新版客服上线后，客服组长的反馈变了：

*"客户说，你们这个 AI 比以前聪明多了，还能记住我之前说的话。"*

小林笑了。从 v1 到 v3，TechStore 的 AI 客服终于像个真正的客服了。

**客服场景，到此收官。接下来，小林要解决第二个痛点——运营周报。**
