# 第 7 章：处理复杂问题——一封邮件多个问题

> TechStore 客服又升级了。但小林又发现了新问题：
>
> 一位客户发来这样一封邮件：
>
> *「你好，我想问几个问题：*
> *1. 你们的 TechPhone Pro 16 有白色吗？*
> *2. 现在买有什么优惠？*
> *3. 如果不喜欢可以退吗？*
> *谢谢。」*
>
> 现在的 Workflow 只回答了第一个问题，后面两个被忽略了。
>
> "我需要让 AI 把问题拆开，一个个回答，最后再汇总。"
>
> 这就是迭代（Iteration）的用途。

## 理解迭代的概念

迭代，就是"对一个列表中的每个元素，执行相同的操作"。

生活中的例子：
- 批改作业：对**每份**作业，执行"阅读、评分、写评语"
- 发送通知：对**每个**收件人，执行"填入姓名、发送邮件"

在我们的场景中：
- 先把邮件拆成一个**问题列表**
- 对**每个**问题，执行"分类、检索、回答"
- 最后把所有答案**汇总**成一封完整的回复

三个步骤：**提取 → 迭代 → 汇总**

## 第一步：添加参数提取器

「参数提取器」节点可以让 AI 从非结构化文本中提取结构化信息。

1. 打开 Workflow，在「开始」节点后添加「参数提取器」节点
2. 配置：

**输入变量**：选择「开始 / user_question」

**提取参数**：
- 参数名：`questions`
- 类型：`Array[String]`（字符串数组）
- 描述：客户邮件中包含的所有问题，每个问题单独作为一个元素

**选择模型**：gpt-3.5-turbo

**提取指令**（可选）：
```
请仔细阅读客户邮件，提取其中的所有问题。
每个独立的问题作为数组的一个元素。
如果只有一个问题，也请以数组形式返回。
```

现在，如果输入是：
```
你们有白色吗？现在有优惠吗？可以退吗？
```

参数提取器会输出：
```json
["你们有白色吗？", "现在有优惠吗？", "可以退吗？"]
```

## 第二步：添加迭代节点

「迭代」节点会对数组中的每个元素执行相同的子流程。

1. 添加「迭代」节点，连接到「参数提取器」后面
2. 配置迭代输入：选择「参数提取器 / questions」
3. 迭代节点会创建一个"子画布"

双击迭代节点（或点击「编辑迭代内容」），进入子画布。

你会看到一个特殊的开始节点，里面有一个 `item` 变量——这就是当前正在处理的那个问题。

## 第三步：构建迭代内的子流程

在迭代子画布中，构建处理单个问题的流程：

**1. 添加「知识检索」节点**
- 查询变量：选择 `item`（当前问题）
- 知识库：选择你的知识库

**2. 添加「LLM」节点**

System 提示词：
```
你是 TechStore 的客服。请针对这个具体问题给出简洁的回答。

参考资料：
{{#context#}}

注意：只回答当前这一个问题，不要发散。
```

User：`{{item}}`

**3. 配置迭代输出**

选择 LLM 的输出作为迭代结果。

迭代节点会对每个问题执行这个子流程，最后输出一个**答案数组**。

## 第四步：汇总答案

迭代结束后，我们有了一个答案数组。但客户需要的是一封完整的邮件，不是一个列表。

1. 在迭代节点后添加「LLM」节点
2. 配置汇总 LLM：

```
你是 TechStore 的客服。请将以下问答整理成一封完整、通顺的邮件回复。

客户原始邮件：
{{user_question}}

各问题的回答：
{{iteration_output}}

要求：
1. 开头友好问候
2. 按顺序回答每个问题，用编号标注
3. 结尾感谢客户，署名 TechStore 客服团队
```

3. 连接到结束节点

完整的 Workflow 结构：

```
开始（接收邮件）
    ↓
参数提取器（提取问题列表）
    ↓
迭代（对每个问题执行子流程）
    ├── 知识检索
    └── LLM 回答
    ↓
LLM 汇总（整理成完整邮件）
    ↓
结束（输出邮件）
```

## 测试复杂邮件

**输入：**
```
你好，我想问几个问题：
1. 你们的 TechPhone Pro 16 有白色吗？
2. 现在买有什么优惠？
3. 如果不喜欢可以退货吗？
谢谢。
```

点击运行，观察执行过程：

1. 参数提取器提取出 3 个问题
2. 迭代节点执行了 3 次子流程
3. 每个问题都得到了对应的回答
4. 最后汇总成了一封完整的邮件

**输出示例：**

```
尊敬的客户，您好！

感谢您对 TechStore 的关注，以下是您问题的解答：

1. 关于 TechPhone Pro 16 的颜色
   是的，TechPhone Pro 16 有冰川白配色可选，另外还有星空黑和暮光紫两款颜色。

2. 关于目前的优惠活动
   目前购买 TechPhone Pro 16 可享受以下优惠：参与以旧换新最高可抵 1000 元……

3. 关于退货政策
   根据我们的政策，自签收之日起 7 天内，商品未拆封、不影响二次销售的情况下……

如有其他问题，欢迎随时咨询。

TechStore 客服团队
```

---

小林看着这个结果，终于露出了满意的笑容。

*"现在不管客户问几个问题，都能一一回答了。"*
