# 第 15 章：知识库进阶——让 AI 答得更准

> AI 客服上线一段时间后，小林在日志里发现了一个规律：大部分答错的问题，不是 AI 不会答，而是**检索到了错误的内容**。
>
> 比如客户问"TechPhone Pro 16 的保修期多久"，AI 返回的却是 TechBuds Pro 3 的保修条款——因为两段内容都包含"保修"这个关键词，检索时分不清该给哪一段。
>
> "知识库的内容没问题，但检索的方式需要优化。"
>
> 小林决定深入研究一下 Dify 的知识库配置。

这一章不涉及 Workflow 编排，专门讲知识库的进阶用法：怎么分段、怎么索引、怎么检索、怎么测试——把 RAG 这条线调到最优。

## 回顾：知识库的基本流程

先回忆一下第 3 章做了什么：

1. 上传文档
2. 自动分段（切成 chunk）
3. 向量化索引（把文本变成向量）
4. 检索时找最相似的 chunk → 喂给 LLM

这个流程用默认配置就能跑起来。但默认配置是"通用方案"，遇到具体业务时可能不够好。优化的方向有三个：**怎么切**、**怎么索引**、**怎么检索**。

## 分段策略：怎么切

分段（Chunking）是整个 RAG 链路里最关键的一步。切得好不好，直接决定检索准不准。

### 基本概念

- **分隔符（Delimiter）**：在哪里切。比如 `\n\n` 按段落切，`\n` 按行切
- **最大长度（Max Chunk Length）**：每个 chunk 最多多少字符。超了就强制切
- **重叠（Overlap）**：相邻 chunk 之间重叠多少字符，防止重要信息正好被切断

### 两种分段模式

Dify 提供两种分段模式：**通用模式**和**父子模式**。

**通用模式（General）**

所有 chunk 大小一样，检索命中哪个就返回哪个。适合内容比较短、每段自成一体的文档（FAQ、术语表等）。

**父子模式（Parent-Child）**

文档先切成大段（父 chunk），每个父 chunk 再切成小段（子 chunk）。检索时用子 chunk 做精准匹配，命中后返回它所属的整个父 chunk 给 LLM。

这解决了一个经典的矛盾：
- chunk 切小了 → 匹配精准，但上下文不够，LLM 可能理解不全
- chunk 切大了 → 上下文丰富，但匹配不够精准，容易混入无关内容

父子模式两全其美：**用小 chunk 精准定位，用大 chunk 提供完整上下文**。

::: tip 什么时候用父子模式
文档比较长、结构比较密的时候用父子模式。比如产品手册、技术文档、合同条款。

如果是简短的 FAQ、每条独立的问答对，通用模式就够了。
:::

### 实操：调整分段设置

在知识库详情页 → 文档设置里，可以调整分段参数：

1. **选择模式**：通用 或 父子
2. **设置分隔符**：根据文档结构选。Markdown 文档推荐用 `\n\n`（段落），HTML 推荐用标签分割
3. **设置最大长度**：通用模式建议 500-1000 字符；父子模式的子 chunk 建议 200-500，父 chunk 建议 1000-2000
4. **预览**：点击「预览」查看分段效果，不满意就调参数

::: warning 注意
分段模式在知识库创建后不能改。如果想换模式，需要新建知识库重新上传。不过分隔符和最大长度可以随时调整。
:::

## 索引方式：怎么索引

分段之后，每个 chunk 需要被索引，这样检索时才能找到。Dify 提供两种索引方式：

| 索引方式 | 原理 | 优点 | 缺点 |
|----------|------|------|------|
| **高质量（High Quality）** | 用 Embedding 模型把文本转成向量 | 能理解语义，"退货政策"和"退款流程"能匹配上 | 消耗 Embedding 模型的 token |
| **经济（Economical）** | 关键词倒排索引 | 不消耗 token，速度快 | 只能匹配关键词，语义理解差 |

**建议：** 正式项目用高质量索引。经济模式只适合预算特别紧、或者内容量极大但精度要求不高的场景。

高质量索引创建后不能降级为经济模式，但经济模式可以升级为高质量。

## 检索策略：怎么检索

索引方式选了高质量之后，还有三种检索策略可选：

### 向量检索（Vector Search）

把用户的问题也转成向量，和知识库里的 chunk 向量做相似度比较，返回最近的几个。

优点：能理解语义。用户问"怎么退货"，能匹配到"退款流程"。
缺点：对精确关键词不敏感。用户问"订单号 20251128"，向量检索可能不如关键词检索。

### 全文检索（Full-Text Search）

传统的关键词匹配，类似搜索引擎。

优点：关键词精确匹配很强。
缺点：不理解语义。"退货"和"退款"可能匹配不上。

### 混合检索（Hybrid Search）—— 推荐

同时做向量检索和全文检索，然后合并结果。可以设置语义和关键词的权重比例。

这是大多数场景的最佳选择——兼顾语义理解和关键词匹配。

**权重设置建议：**
- 语义优先（0.7 语义 / 0.3 关键词）：适合开放式问答，比如"你们的退货政策是什么"
- 关键词优先（0.3 语义 / 0.7 关键词）：适合精确查询，比如"查一下订单 20251128"
- 均衡（0.5 / 0.5）：不确定的时候先用这个

## Rerank：检索结果重排序

检索拿回来一堆 chunk 之后，可以再用 **Rerank 模型** 做一次精排——让最相关的排到最前面。

Rerank 的原理：把用户的问题和每个 chunk 放在一起，用专门的排序模型打分，比单纯的向量相似度更准。

**配置方式：**
1. 在「设置 → 模型供应商」里配置 Rerank 模型（比如 Cohere Rerank、Jina Reranker）
2. 在知识库的检索设置里开启 Rerank

**两个关键参数：**
- **TopK**：最多返回几个 chunk。默认 3，内容多的时候可以调到 5-10
- **Score Threshold**：最低相似度分数。低于这个分数的 chunk 不返回。默认 0.5，如果发现返回了太多不相关内容，调高到 0.7

::: tip
Rerank 会消耗额外的 token，但对检索准确率的提升非常明显。如果你的知识库内容量大、主题重叠多，强烈建议开启。
:::

## 检索测试：上线前先验证

知识库配置好之后，别急着接入应用。先用**检索测试**功能验证一下。

**操作步骤：**
1. 打开知识库详情页
2. 点击左侧的「检索测试」
3. 输入一个真实的用户问题
4. 查看返回的 chunk 是否相关

**测试要覆盖的场景：**
- 常见问题：看看 TopK 里有没有正确答案
- 边界问题：比如产品名称相似的场景，检索会不会混淆
- 无答案问题：知识库里没有的内容，检索结果是否分数很低（应该被过滤掉）

如果测试结果不理想，回去调整分段策略、检索方式或 Rerank 参数，然后再测。

## Knowledge Pipeline：可视化编排知识处理流程

如果你觉得上面的配置还不够灵活，Dify 提供了更强大的工具——**Knowledge Pipeline**。

Knowledge Pipeline 让你像搭 Workflow 一样，可视化地编排文档的处理流程：

```
数据源 → 数据提取 → 数据处理 → 知识存储
```

四个阶段分别做：

| 阶段 | 做什么 | 举例 |
|------|--------|------|
| **数据源** | 从哪里读数据 | 本地文件、网页、Notion |
| **数据提取** | 把原始格式转成文本 | PDF 解析、HTML 清洗 |
| **数据处理** | 分段、清洗、增强 | 自定义分段规则、去噪、生成摘要 |
| **知识存储** | 索引和存储 | 向量化、写入知识库 |

每个阶段都可以用不同的节点和插件组合，比上面讲的"快速创建"灵活得多。

**什么时候用 Knowledge Pipeline：**
- 文档格式复杂（混合 PDF、表格、图片）
- 需要自定义清洗规则（去掉页眉页脚、水印文字等）
- 有多个数据源需要统一处理
- 需要对文档内容做预处理（摘要、翻译、格式转换）

**什么时候不需要：**
- 文档格式简单（纯文本、Markdown）
- 默认的分段和索引够用
- 刚入门，先用快速创建练手

::: tip
Knowledge Pipeline 有内置模板，不需要从零搭建。打开后选一个模板，在上面改就行。
:::

## 实操练习：优化 TechStore 知识库

回到 TechStore 的场景。小林发现以下问题：

**问题 1：** 产品 A 和产品 B 的保修条款混淆
- 原因：两段内容都包含"保修"，通用模式分段后相似度太接近
- 解法：改用**父子分段模式**，让子 chunk 更小更精准

**问题 2：** 客户输入订单号查询时，检索结果不相关
- 原因：纯向量检索对精确数字匹配不好
- 解法：改用**混合检索**，提高关键词权重

**问题 3：** 返回了很多不相关的 chunk，LLM 反而被干扰
- 原因：TopK 太高，Score Threshold 太低
- 解法：开启 **Rerank**，TopK 调到 3，Score Threshold 调到 0.7

小林调完参数后，跑了一轮检索测试。结果好了很多——之前混淆的产品问题不再出现，订单号查询也能精准命中了。

---

知识库是 RAG 应用的地基。地基打得好，上面的 Workflow 和 Chatflow 才能发挥出真正的效果。

::: tip 一句话总结
- 内容简单 → 快速创建 + 通用分段 + 高质量索引
- 内容复杂 → Knowledge Pipeline + 父子分段 + 混合检索 + Rerank
- 不确定效果 → 跑检索测试，看数据说话
:::
